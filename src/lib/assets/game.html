<html>

<style>
    canvas {
        margin: auto;
        width: 30vw;
        border: 1px solid black;
        background-color: lightgreen;
    }
</style>


<body>
    <canvas id="canvas" width="1000" height="1000"> </canvas>

    <script>
        let canvas = document.getElementById("canvas");
        let context = canvas.getContext("2d");

        const rect = canvas.getBoundingClientRect()
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const sprites = ['🐮', '🐭', '🐰', '🐱', '🐴', '🐶', '🐷', '🐹', '🐤', '🍰', '🎂', '🍰', '🎂', '🍰', '🎂']

        const enemies = ['🍰', '🎂']
        let baseSpeed = 7
        let maxMobs = 10
        const rotSpeed = Math.PI / 64

        let objects = []
        let score = 0

        let state = 0
        let counter = 1

        context.font = "80px Dosis";

        function init() {
            objects.push(new_obj())
        }

        function new_obj() {
            return {
                sprite: sprites[Math.floor(Math.random() * sprites.length)],
                posX: Math.floor(Math.random() * canvas.width),
                posY: canvas.height + 64,
                spX: baseSpeed * ((Math.random() * 2) - 1),
                spY: baseSpeed * ((Math.random() * 2) - 1),
                rot: rotSpeed * ((Math.random() * 2) - 1),
            }
        }

        function update() {
            switch (state) {
                case 0:
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.textAlign = "center";
                    context.textBaseline = "middle";
                    context.fillText("Come las tartas (🎂)", 500, 250)
                    context.fillText("Evita los animales (🐶)", 500, 350)
                    context.fillText(counter, 500, 750)
                    if (counter < 0 ) state = 1
                    break;

                case 1:
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    objects.forEach(e => {
                        context.save();
                        context.textAlign = "center";
                        context.textBaseline = "middle";
                        move_sprite(e);
                        rotate_sprite(e);
                        context.fillText(e.sprite, 0, 0)
                        context.restore();
                    });

                    context.fillText("Puntos: " + score, 800, 70)

                    objects = objects.filter(e =>
                        e.posX > -80 &&
                        e.posX < canvas.width + 80 &&
                        e.posY > -80 &&
                        e.posY < canvas.height + 80)

                    if (objects.length < maxMobs) {
                        objects.push(new_obj())
                    }

                    if (score >= 10) {
                        state = 2
                    }
                    break;
                case 2:
                    context.font = "64px sans-serif";
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.fillText("🎉🎊Feliz Cumpleaños Pau 🎊🎉", 500, 333)
                    context.fillText("Recarga para jugar de nuevo", 500, 666)
                    break;
            }

        }

        function rotate_sprite(sprite) {

            sprite.rot += rotSpeed
            context.rotate(sprite.rot)

        }

        function move_sprite(sprite) {
            sprite.posX += sprite.spX
            sprite.posY += sprite.spY

            context.translate(sprite.posX, sprite.posY)

        }

        function listen_input(e) {

            if (e.buttons == 1) {
                const lowX = (e.clientX - rect.left - 20) * scaleX
                const highX = (e.clientX - rect.left + 20) * scaleX
                const lowY = (e.clientY - rect.top - 20) * scaleY
                const highY = (e.clientY - rect.top + 20) * scaleY
                deleted = objects.filter(o => (o.posX > lowX && o.posX < highX) && (o.posY > lowY && o.posY < highY))
                objects = objects.filter(o => (o.posX < lowX || o.posX > highX) || (o.posY < lowY || o.posY > highY))

                deleted.forEach(e => {
                    if (enemies.includes(e.sprite)) {
                        score += 1
                        baseSpeed += 2
                        maxMobs += 2
                    } else {
                        score -= 1
                    }
                });
            }

        }

        function countDown(){
            counter--;
        }

        init()
        addEventListener("mousemove", listen_input);
        setInterval(update, 16)
        setInterval(countDown, 1000)
        console.log(objects)
    </script>
</body>

</html>